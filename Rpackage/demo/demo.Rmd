---
title: "Example usage of DECODE"
author: "Shahin Mohammadi"
output: html_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = T, warning=FALSE, message = F)
```


### Import expression matrix

```{r}
ds_folder = '../../input/datasets/PBMC_4k_10X'
expr_file = paste(ds_folder, 'expression.txt', sep = '/')
expression = read.table(expr_file, header = T, row.names = NULL)
gene_names = expression[, 1]
expression = expression[, -1]
expression = as.matrix(expression)
```

### Normalize data (if needed)

```{r}
X = as.matrix(expression)
if(max(X) > 50) {
  Sums = colSums(X)
  med = median(Sums)
  X = med*scale(X, center=FALSE, scale=Sums)
  X = log(1 + X)
}
```

### Filter genes that are not expressed in at least 5 cells

```{r}
gene_mask = rowSums(X != 0) >= 10
X = X[gene_mask,]
gene_names = gene_names[gene_mask]
```


### Sparsify
```{r}
library(Matrix)

X_sparse = as(X, "sparseMatrix")
```

### Load sample annotations:

```{r}
annotations = read.table('../../input/datasets/PBMC_4k_10X/sample_annotations.txt', sep='\t', header = T)
```


### Use DECODE to perform preferential analysis between CD8/CD4 T-cells

```{r}
require(DECODE)
rows = seq(1, dim(X)[1])
cols_CD8 = which(annotations$Full_Labels == "CD8+ Cytotoxic T")
cols_CD4 = which(annotations$Full_Labels == "CD4+/CD45RA+/CD25- Naive T")
thread_no = 8
HK_z_threshold = 3
gene_pvals = AssessFeatures_betweenGroups(X_sparse, rows, cols_CD8, cols_CD4, HK_z_threshold, thread_no)

sorted_markers_CD4_vs_CD8 = data.frame(genes=gene_names[order(gene_pvals)], pval=sort(gene_pvals));

sorted_markers_CD4_vs_CD8[1:20, ]
```


### Use DECODE to identify preferential genes in B-cells

```{r}
require(DECODE)
rows = seq(1, dim(X)[1])
cols = which(annotations$Labels == "B")
thread_no = 8
HK_z_threshold = 3
gene_pvals_B = AssessFeatures(X_sparse, rows, cols, HK_z_threshold, thread_no);

sorted_markers = data.frame(genes=gene_names[order(gene_pvals_B)], pval=sort(gene_pvals_B))
sorted_markers[1:20, ]

```

```{r}
require(ggplot2)
B_module = which(gene_pvals_B < 0.05)
profile_scores = ProfileModule(X_sparse, B_module);

Data = data.frame(x = seq(1, length(profile_scores)), y = profile_scores)

g = ggplot(Data, aes(x,y)) + geom_point() + geom_smooth() + xlab("Cells") + ylab("-log(pval)") 
plot(g)
```

